<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>App</title>
    <link rel="shortcut icon" href="icon.png" type="image/png">
<link rel="apple-touch-icon" href="à§¨à§¦à§¨à§«à§§à§¨à§§à§ª_à§§à§®à§«à§¯à§©à§¨.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- FIREBASE COMPAT (Stable for Hosting) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        /* =========================================
           1. CORE & ANIMATED BACKGROUND
           ========================================= */
        :root {
            --nav-height: 70px;
            --header-height: 60px;
            --radius: 16px;
            --font-main: 'Poppins', sans-serif;
        }

        * {
            box-sizing: border-box; margin: 0; padding: 0;
            -webkit-tap-highlight-color: transparent;
            font-family: var(--font-main);
            user-select: none;
        }

        body {
            width: 100vw; height: 100vh;
            overflow: hidden;
            display: flex; flex-direction: column;
            /* Default Animation Setup */
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            color: #333;
            transition: background-image 0.5s ease;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* --- 5 PREMIUM THEMES (RESTORED) --- */
        body.theme-1 { background-image: linear-gradient(-45deg, #FF9A9E, #FECFEF, #F6D365, #FDA085); --primary: #FF6B6B; }
        body.theme-2 { background-image: linear-gradient(-45deg, #a18cd1, #fbc2eb, #8fd3f4, #84fab0); --primary: #8E2DE2; }
        body.theme-3 { background-image: linear-gradient(-45deg, #2980B9, #6DD5FA, #FFFFFF, #B2FEFA); --primary: #0072ff; }
        body.theme-4 { background-image: linear-gradient(-45deg, #11998e, #38ef7d, #00b09b, #96c93d); --primary: #11998e; }
        body.theme-5 { background-image: linear-gradient(-45deg, #fce38a, #f38181, #eaffd0, #95e1d3); --primary: #f38181; }

        /* HEADER */
        header {
            height: var(--header-height);
            padding: 0 20px;
            display: flex; align-items: center; justify-content: flex-end;
            position: sticky; top: 0; z-index: 100;
        }
        
        .refresh-btn { 
            width: 45px; height: 45px; border-radius: 50%; 
            background: rgba(255,255,255,0.6); backdrop-filter: blur(5px);
            display: flex; align-items: center; justify-content: center;
            font-size: 22px; color: #333; cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: 0.3s;
        }
        .refresh-btn:active { transform: rotate(180deg); }

        #app-container {
            flex: 1; overflow-y: auto;
            padding-bottom: 100px; scroll-behavior: smooth;
        }

        /* PROMO BANNER */
        .promo-banner {
            margin: 10px 20px 20px 20px;
            background: linear-gradient(135deg, #ff416c, #ff4b2b);
            color: white; padding: 20px; border-radius: var(--radius);
            text-align: center; box-shadow: 0 10px 30px rgba(255, 65, 108, 0.4);
            position: relative; display: none;
            animation: slideDown 0.5s ease;
        }
        .promo-banner.active { display: block; }
        
        .promo-close {
            position: absolute; top: 10px; right: 15px;
            font-size: 24px; font-weight: bold; cursor: pointer; opacity: 0.8;
        }
        .promo-title { font-size: 20px; font-weight: 800; text-transform: uppercase; margin-bottom: 5px; letter-spacing: 1px; }
        .promo-desc { font-size: 14px; opacity: 0.95; }
        
        @keyframes slideDown { from{opacity:0; transform:translateY(-20px);} to{opacity:1; transform:translateY(0);} }

        /* SLIDER (16:9 + SWIPEABLE) */
        .slider-section {
            margin: 0 20px 30px 20px;
            width: calc(100% - 40px);
            aspect-ratio: 16/9;
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
            position: relative;
            background: rgba(255,255,255,0.5);
        }
        .slider-track { display: flex; height: 100%; transition: transform 0.4s ease-out; cursor: grab; }
        .slide-item {
            min-width: 100%; height: 100%;
            background-size: cover; background-position: center;
        }
        .slider-dots { position: absolute; bottom: 10px; width: 100%; display: flex; justify-content: center; gap: 8px; z-index: 10; }
        .dot { width: 8px; height: 8px; background: rgba(255,255,255,0.6); border-radius: 50%; transition: 0.3s; }
        .dot.active { width: 25px; border-radius: 12px; background: #fff; }

        /* PRODUCTS */
        .product-list { display: flex; flex-direction: column; gap: 25px; padding: 0 20px; }
        .product-card {
            background: rgba(255,255,255,0.9); border-radius: var(--radius);
            overflow: hidden; box-shadow: 0 8px 25px rgba(0,0,0,0.05);
            display: flex; flex-direction: column; position: relative;
            border: 1px solid rgba(255,255,255,0.6);
        }
        .product-card:active { transform: scale(0.98); }
        .p-image-box { width: 100%; aspect-ratio: 16/9; background: #e0e0e0; position: relative; }
        .p-img { width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 0.4s; }
        .p-img.loaded { opacity: 1; }
        
        .discount-tag {
            position: absolute; top: 15px; left: 15px;
            background: #ff0000; color: white;
            padding: 5px 15px; border-radius: 50px;
            font-size: 13px; font-weight: 800;
            box-shadow: 0 5px 15px rgba(255,0,0,0.4);
            z-index: 20; border: 2px solid white;
        }
        .p-details { padding: 20px; }
        .p-title { font-size: 18px; font-weight: 700; margin-bottom: 8px; color: #222; line-height: 1.4; }
        .p-price-row { display: flex; align-items: baseline; gap: 10px; }
        .price-now { font-size: 24px; font-weight: 800; color: var(--primary); }
        .price-old { font-size: 16px; text-decoration: line-through; color: #999; font-weight: 500; }

        /* NAV */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            height: var(--nav-height); background: rgba(255,255,255,0.9);
            backdrop-filter: blur(15px); border-top: 1px solid rgba(255,255,255,0.5);
            display: flex; justify-content: space-around; align-items: center;
            box-shadow: 0 -10px 30px rgba(0,0,0,0.05); z-index: 500;
        }
        .nav-btn { flex: 1; height: 100%; background: none; border: none; color: #aaa; transition: 0.3s; }
        .nav-btn.active { color: var(--primary); transform: translateY(-2px); }
        .nav-icon { font-size: 28px; }

        /* WA */
        .wa-float {
            position: fixed; bottom: 95px; right: 25px;
            width: 65px; height: 65px; z-index: 600;
            filter: drop-shadow(0 5px 15px rgba(0,0,0,0.2));
            transition: transform 0.2s; animation: pulse 3s infinite;
        }
        .wa-float img { width: 100%; height: 100%; display: block; }
        .wa-float:active { transform: scale(0.9); }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* MODALS */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 2000;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: 0.3s; backdrop-filter: blur(5px);
        }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        
        .modal-box {
            background: #FFF; width: 90%; max-width: 400px;
            padding: 30px; border-radius: 20px; text-align: center;
            box-shadow: 0 25px 50px rgba(0,0,0,0.25); position: relative;
            transform: scale(0.8); transition: 0.3s;
        }
        .modal-overlay.open .modal-box { transform: scale(1); }

        .modal-close-btn {
            position: absolute; top: 10px; right: 15px;
            font-size: 30px; font-weight: bold; color: #555;
            cursor: pointer; line-height: 1; z-index: 10;
        }

        .btn-primary {
            background: var(--primary); color: white; border: none;
            padding: 15px; width: 100%; border-radius: 12px;
            font-weight: 700; font-size: 16px; margin-top: 20px;
            cursor: pointer; box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        .auth-inp {
            width: 100%; padding: 15px; background: #f4f6f8;
            border: 2px solid transparent; border-radius: 12px; margin-bottom: 12px;
            font-size: 16px; transition: 0.3s;
        }
        .auth-inp:focus { background: white; border-color: var(--primary); outline: none; }

        /* DETAILS */
        .details-sheet {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #FFF; z-index: 1000; display: flex; flex-direction: column;
            transform: translateY(100%); transition: 0.3s;
        }
        .details-sheet.active { transform: translateY(0); }
        .back-circle {
            position: absolute; top: 20px; left: 20px; z-index: 20;
            width: 50px; height: 50px; border-radius: 50%;
            background: rgba(255,255,255,0.9);
            display: flex; align-items: center; justify-content: center;
            border: none; font-size: 24px; color: #333; box-shadow: 0 5px 15px rgba(0,0,0,0.1); cursor: pointer;
        }
        .dt-scroll { flex: 1; overflow-y: auto; padding-bottom: 40px; }
        .dt-gallery { height: 400px; background: #000; display: flex; overflow-x: auto; scroll-snap-type: x mandatory; }
        .dt-img { min-width: 100%; height: 100%; object-fit: contain; scroll-snap-align: center; }
        .dt-info { padding: 30px 25px; background: white; border-radius: 30px 30px 0 0; margin-top: -30px; position: relative; }
        
        .video-container {
            margin-top: 30px; width: 100%; border-radius: 16px; overflow: hidden;
            background: #000; position: relative; padding-bottom: 56.25%; display: none;
        }
        .video-container.active { display: block; }
        .video-iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; }

        /* Profile */
        .profile-view { display: none; height: 100%; flex-direction: column; align-items: center; padding-top: 60px; }
        .profile-view.active { display: flex; }
        .avatar { width: 120px; height: 120px; background: var(--primary); border-radius: 50%; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; color: white; font-size: 50px; font-weight: 800; }
        .hidden { display: none !important; }
    </style>
</head>
<body class="theme-1">

    <header>
        <div class="refresh-btn" onclick="window.location.reload()">&#8635;</div>
    </header>

    <div id="app-container">
        <div id="home-view">
            
            <!-- PROMO BANNER -->
            <div class="promo-banner" id="promo-banner">
                <div class="promo-close" onclick="document.getElementById('promo-banner').style.display='none'">&times;</div>
                <div style="font-size:20px; font-weight:800; margin-bottom:5px;" id="promo-title">SALE</div>
                <div style="font-size:14px;" id="promo-desc">Discounts active!</div>
            </div>

            <!-- SLIDER (TOUCH ENABLED) -->
            <div class="slider-section" id="slider-box">
                <div class="slider-track" id="slider-track"></div>
                <div class="slider-dots" id="slider-dots"></div>
            </div>

            <!-- PRODUCTS -->
            <div class="product-list" id="product-list">
                <div style="text-align:center; padding:50px; color:#888;">Loading...</div>
            </div>
        </div>

        <div id="profile-view" class="profile-view">
            <div class="avatar" id="p-avatar">?</div>
            <h2 id="p-name">Guest</h2>
            <p id="p-email" style="color:#666; margin-bottom:30px;">Not logged in</p>
            <button class="btn-primary" style="width:auto; padding:15px 50px;" onclick="authHandler()">Login / Signup</button>
        </div>
    </div>

    <div class="bottom-nav">
        <button class="nav-btn active" onclick="nav('home', this)"><div class="nav-icon">&#8962;</div></button>
        <button class="nav-btn" onclick="nav('profile', this)"><div class="nav-icon">&#128100;</div></button>
    </div>

    <a href="https://wa.me/8801974643831" class="wa-float" target="_blank">
        <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg">
    </a>

    <!-- NOTICE MODAL (Cross Icon) -->
    <div id="notice-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-close-btn" onclick="closeModal('notice-modal')">&times;</div>
            <img src="" id="n-img" class="hidden" style="width:100%; border-radius:12px; margin-bottom:15px;">
            <h3 id="n-text" style="color:var(--primary); margin-bottom:10px; font-weight:700;"></h3>
        </div>
    </div>

    <!-- AUTH MODAL -->
    <div id="auth-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-close-btn" onclick="closeModal('auth-modal')">&times;</div>
            <h2 id="auth-title" style="margin-bottom:20px;">Login</h2>
            <input type="email" id="u-email" class="auth-inp" placeholder="Email">
            <input type="password" id="u-pass" class="auth-inp" placeholder="Password">
            <div id="reg-fields" class="hidden">
                <input type="text" id="u-name" class="auth-inp" placeholder="Name">
                <input type="tel" id="u-phone" class="auth-inp" placeholder="Phone">
            </div>
            <button class="btn-primary" onclick="submitAuth()">SUBMIT</button>
            <p style="margin-top:20px; color:#666; font-size:14px;">
                <span id="auth-toggle-txt">New?</span> <b style="color:var(--primary); cursor:pointer;" onclick="toggleAuthMode()">Create Account</b>
            </p>
        </div>
    </div>

    <!-- DETAILS -->
    <div id="details-sheet" class="details-sheet">
        <button class="back-circle" onclick="closeDetails()">&#8592;</button>
        <div class="dt-scroll">
            <div class="dt-gallery" id="d-gallery"></div>
            <div class="dt-info">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h1 id="d-price" style="font-size:30px; font-weight:900; color:var(--primary);"></h1>
                    <span id="d-badge" class="discount-tag" style="position:static; padding:6px 15px; display:inline-block;"></span>
                </div>
                <h2 id="d-title" style="margin:15px 0;"></h2>
                <p id="d-desc" style="color:#666; line-height:1.6;"></p>
                <div id="video-container" class="video-container"></div>
                <div id="buy-btn-wrapper"></div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDFM4gHGZKIkCZ-EqdqhRQd7tnPmjqxbBs",
            authDomain: "cartoon-course-website.firebaseapp.com",
            projectId: "cartoon-course-website",
            storageBucket: "cartoon-course-website.firebasestorage.app",
            messagingSenderId: "931628256386",
            appId: "1:931628256386:web:d9950ef380eefda78a789b"
        };

        try {
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();
            let currentUser = null, isLogin = true;

            // LOAD DATA
            function loadApp() {
                // Themes
                db.collection("settings").doc("theme_config").onSnapshot(d => { 
                    if(d.exists) document.body.className = `theme-${d.data().active_theme_id||1}`; 
                });
                
                // Promo Banner
                db.collection("settings").doc("promo").onSnapshot(d => {
                    if(d.exists && d.data().discountPercent > 0) {
                        document.getElementById("promo-title").innerText = "ðŸ”¥ " + (d.data().eventName || "SALE");
                        document.getElementById("promo-desc").innerText = `Flat ${d.data().discountPercent}% OFF!`;
                        document.getElementById("promo-banner").classList.add("active");
                    } else document.getElementById("promo-banner").classList.remove("active");
                });

                // Slider (Swipe Enabled)
                db.collection("slider").get().then(snap => {
                    const t = document.getElementById("slider-track"), d = document.getElementById("slider-dots");
                    const slides = []; snap.forEach(s => slides.push(s.data()));
                    if(slides.length) {
                        slides.forEach((s, i) => {
                            const div = document.createElement("div"); div.className = "slide-item";
                            div.style.backgroundImage = `url('${s.imageUrl}')`;
                            div.onclick = () => { if(s.activityUrl) window.location.href = s.activityUrl; };
                            t.appendChild(div);
                            const dot = document.createElement("div"); dot.className = i===0?"dot active":"dot"; d.appendChild(dot);
                        });
                        
                        let idx = 0;
                        const nextSlide = () => { idx=(idx+1)%slides.length; updateSlide(); };
                        const prevSlide = () => { idx=(idx-1+slides.length)%slides.length; updateSlide(); };
                        const updateSlide = () => {
                            t.style.transform = `translateX(-${idx*100}%)`;
                            Array.from(d.children).forEach((el,i)=>el.className=i===idx?"dot active":"dot");
                        };
                        
                        setInterval(nextSlide, 4000);

                        // TOUCH SWIPE LOGIC
                        let startX = 0;
                        const sliderBox = document.getElementById('slider-box');
                        sliderBox.addEventListener('touchstart', e => startX = e.touches[0].clientX);
                        sliderBox.addEventListener('touchend', e => {
                            if(startX - e.changedTouches[0].clientX > 50) nextSlide();
                            if(e.changedTouches[0].clientX - startX > 50) prevSlide();
                        });
                    }
                });

                // Products
                db.collection("products").onSnapshot(snap => {
                    const list = document.getElementById("product-list"); list.innerHTML = "";
                    snap.forEach(doc => {
                        const p = doc.data();
                        const price = parseFloat(p.price)||0, disc = parseFloat(p.discount)||0;
                        let final = disc>0 ? price-(price*disc/100) : price;
                        const img = (p.images&&p.images[0]) ? p.images[0] : p.imageUrl;
                        
                        let badge='', priceHtml=`<span class="price-now">à§³${Math.round(final)}</span>`;
                        if(disc>0) {
                            badge=`<div class="discount-tag">-${disc}% OFF</div>`;
                            priceHtml+=`<span class="price-old">à§³${price}</span>`;
                        }

                        const el = document.createElement('div'); el.className = 'product-card';
                        el.innerHTML = `
                            <div class="p-image-box"><img src="${img}" class="p-img" onload="this.classList.add('loaded')">${badge}</div>
                            <div class="p-details"><div class="p-title">${p.title}</div><div class="p-price-row">${priceHtml}</div></div>
                        `;
                        el.onclick = () => openDetails(p, final);
                        list.appendChild(el);
                    });
                });

                // Notice
                db.collection("notice").doc("config").get().then(doc => {
                    if(doc.exists && doc.data().isActive) {
                        const d = doc.data();
                        document.getElementById('n-text').textContent = d.text;
                        if(d.imageUrl) { document.getElementById('n-img').src = d.imageUrl; document.getElementById('n-img').classList.remove('hidden'); }
                        if(d.activityUrl) document.getElementById('n-img').onclick = () => window.location.href = d.activityUrl;
                        setTimeout(() => openModal('notice-modal'), 2000);
                    }
                });
            }

            // ... (Rest of Auth/Nav/Helper functions same as before) ...
            auth.onAuthStateChanged(u => {
                currentUser = u;
                if(u) {
                    document.getElementById("p-name").innerText = u.displayName;
                    document.getElementById("p-email").innerText = u.email;
                    document.getElementById("p-avatar").innerText = (u.displayName||"U")[0].toUpperCase();
                } else {
                    document.getElementById("p-name").innerText = "Guest";
                    document.getElementById("p-email").innerText = "Not logged in";
                    document.getElementById("p-avatar").innerText = "?";
                }
            });

            window.nav = (tab, el) => {
                document.querySelectorAll(".nav-btn").forEach(b => b.classList.remove("active"));
                el.classList.add("active");
                document.getElementById("home-view").style.display = tab==="home"?"block":"none";
                document.getElementById("profile-view").style.display = tab==="profile"?"flex":"none";
            };

            window.authHandler = () => { if(currentUser) auth.signOut(); else openModal('auth-modal'); };
            window.toggleAuthMode = () => {
                isLogin = !isLogin;
                document.getElementById("auth-title").innerText = isLogin?"Login":"Sign Up";
                document.getElementById("reg-fields").classList.toggle("hidden");
                document.getElementById("auth-toggle-txt").innerText = isLogin?"New?":"Account?";
            };
            window.submitAuth = () => {
                const e = document.getElementById("u-email").value, p = document.getElementById("u-pass").value;
                if(isLogin) {
                    auth.signInWithEmailAndPassword(e, p).then(()=>{ closeModal("auth-modal"); nav('profile', document.querySelectorAll('.nav-btn')[1]); }).catch(e=>alert(e.message));
                } else {
                    auth.createUserWithEmailAndPassword(e, p).then(c => {
                        const n = document.getElementById("u-name").value;
                        c.user.updateProfile({displayName: n});
                        db.collection("users").doc(c.user.uid).set({ name: n, email: e, phone: document.getElementById("u-phone").value, joined: new Date().toISOString() });
                        closeModal("auth-modal"); nav('profile', document.querySelectorAll('.nav-btn')[1]);
                    }).catch(e=>alert(e.message));
                }
            };

            function getYoutubeId(url) {
                if(!url) return null;
                const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
                const match = url.match(regExp);
                return (match && match[2].length === 11) ? match[2] : null;
            }

            window.openDetails = (p, final) => {
                document.getElementById('d-title').textContent = p.title;
                document.getElementById('d-desc').textContent = p.description;
                document.getElementById('d-price').textContent = `à§³${Math.round(final)}`;
                
                const b = document.getElementById('d-badge');
                if(p.discount > 0) { b.textContent=`SAVE ${p.discount}%`; b.style.display='inline-block'; } else b.style.display='none';
                
                const g = document.getElementById('d-gallery'); g.innerHTML = '';
                (p.images||[p.imageUrl]).forEach(u => {
                    const i = document.createElement('img'); i.className='dt-img gallery-img'; i.src=u; g.appendChild(i);
                });

                const vidWrap = document.getElementById('video-container'); vidWrap.innerHTML = '';
                if(p.videoUrl) {
                    const ytId = getYoutubeId(p.videoUrl);
                    if(ytId) vidWrap.innerHTML = `<iframe class="video-iframe" src="https://www.youtube.com/embed/${ytId}?autoplay=0&rel=0" allowfullscreen></iframe>`;
                    else vidWrap.innerHTML = `<video class="video-iframe" src="${p.videoUrl}" controls></video>`;
                    vidWrap.classList.add('active');
                } else vidWrap.classList.remove('active');

                const msg = encodeURIComponent(`Hi, I want to buy:\n${p.title}\nPrice: à§³${Math.round(final)}`);
                const waLink = `https://wa.me/8801974643831?text=${msg}`;
                document.getElementById('buy-btn-wrapper').innerHTML = `<button class="btn-primary" style="margin-top:30px; font-size:18px;" onclick="window.open('${waLink}', '_blank')">BUY NOW</button>`;
                document.getElementById('details-sheet').classList.add('active');
            };

            window.closeDetails = () => {
                document.getElementById('details-sheet').classList.remove('active');
                document.getElementById('video-container').innerHTML = '';
            };

            window.openModal = (id) => document.getElementById(id).classList.add('open');
            window.closeModal = (id) => document.getElementById(id).classList.remove('open');

            loadApp();

        } catch (e) { alert("Error: " + e.message); }
    </script>
</body>
</html>
